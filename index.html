// 전체 HTML 구조는 그대로 유지하고, 아래에 관리자 전용 메뉴 추가

<!-- 로그아웃 버튼 -->
<div style="position: fixed; top: 10px; right: 10px;">
  <button onclick="logout()" style="background:#1478FF; color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer;">로그아웃</button>
</div>

<!-- 관리자 전용 메뉴: 문의 히스토리 -->
<div class="container" id="adminPage" style="display:none">
  <h2>문의 히스토리</h2>
  <table style="width:100%; border-collapse:collapse;">
    <thead>
      <tr style="background:#f0f0f0">
        <th style="padding:8px; border:1px solid #ddd;"><input type="checkbox" onclick="toggleAll(this)"></th>
        <th style="padding:8px; border:1px solid #ddd;">번호</th>
        <th style="padding:8px; border:1px solid #ddd; text-align:left;">질문 내용</th>
      </tr>
    </thead>
    <tbody id="historyList"></tbody>
  </table>
  <button onclick="downloadSelectedExcel()" style="margin-top:10px; background:#98DFFF; color:white; border:none; padding:10px 16px; border-radius:6px;">선택 항목 엑셀 다운로드</button>
  <div id="answerDisplay" style="margin-top:20px; font-style: italic; color: #555;"></div>
</div>

<script>
  const allowedIds = ["danbi", "testuser1", "helper123"];
  let savedQuestions = [];
  let savedAnswers = [];

  function logout() {
    localStorage.removeItem('loggedInUser');
    location.reload();
  }

  function toggleAll(master) {
    const checkboxes = document.querySelectorAll('.history-checkbox');
    checkboxes.forEach(cb => cb.checked = master.checked);
  }

  function login() {
    const userId = document.getElementById('userId').value.trim().toLowerCase();
    const errorMsg = document.getElementById('errorMsg');

    if (allowedIds.includes(userId)) {
      localStorage.setItem('loggedInUser', userId);
      savedQuestions = JSON.parse(localStorage.getItem('savedQuestions_' + userId)) || [];
      savedAnswers = JSON.parse(localStorage.getItem('savedAnswers_' + userId)) || [];
      showChatPage(userId);

      if (userId === "danbi") {
        document.getElementById('adminPage').style.display = 'block';
        renderHistory(userId);
      }
    } else {
      errorMsg.textContent = "등록되지 않은 ID입니다.";
    }
  }

  function showChatPage(userId) {
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('chatPage').style.display = 'block';
    document.getElementById('userName').textContent = userId;

    const messages = document.getElementById('messages');
    savedQuestions.forEach((q, i) => {
      const msg = document.createElement('div');
      msg.textContent = "사용자: " + q;
      messages.appendChild(msg);
      if (savedAnswers[i]) {
        const res = document.createElement('div');
        res.textContent = "답변: " + savedAnswers[i];
        res.style.marginBottom = '10px';
        res.style.color = '#444';
        messages.appendChild(res);
      }
    });

    // 전송 버튼 스타일 업데이트
    const sendBtn = document.querySelector('button[onclick="sendMessage()"]');
    if (sendBtn) {
      sendBtn.style.background = '#98DFFF';
      sendBtn.style.color = 'white';
      sendBtn.style.border = 'none';
      sendBtn.style.padding = '10px 16px';
      sendBtn.style.borderRadius = '6px';
    }
  }

  function sendMessage() {
    const input = document.getElementById('userInput');
    const messages = document.getElementById('messages');
    const userId = localStorage.getItem('loggedInUser');
    if (input.value.trim()) {
      const question = input.value.trim();
      const message = document.createElement('div');
      message.textContent = "사용자: " + question;
      messages.appendChild(message);

      const mockAnswer = "이 질문에 대한 답변은 준비 중입니다.";
      const answer = document.createElement('div');
      answer.textContent = "답변: " + mockAnswer;
      answer.style.marginBottom = '10px';
      answer.style.color = '#444';
      messages.appendChild(answer);

      savedQuestions.push(question);
      savedAnswers.push(mockAnswer);
      localStorage.setItem('savedQuestions_' + userId, JSON.stringify(savedQuestions));
      localStorage.setItem('savedAnswers_' + userId, JSON.stringify(savedAnswers));
      input.value = "";
      if (userId === "danbi") renderHistory(userId);
    }
  }

  function renderHistory(userId) {
    const list = document.getElementById('historyList');
    list.innerHTML = "";
    savedQuestions.forEach((q, i) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td style="padding:8px; border:1px solid #ddd;"><input type="checkbox" class="history-checkbox" data-index="${i}"></td>
        <td style="padding:8px; border:1px solid #ddd; text-align:center;">${i + 1}</td>
        <td style="padding:8px; border:1px solid #ddd; cursor:pointer; text-align:left;" onclick="showAnswer(${i})">${q}</td>
      `;
      list.appendChild(row);
    });
  }

  function showAnswer(i) {
    const answerDisplay = document.getElementById('answerDisplay');
    const answer = savedAnswers[i] || "답변이 등록되지 않았습니다.";
    answerDisplay.textContent = `답변: ${answer}`;
  }

  function downloadSelectedExcel() {
    let csv = "질문 번호,질문 내용,답변 내용
";
    document.querySelectorAll('.history-checkbox:checked').forEach(cb => {
      const i = parseInt(cb.getAttribute('data-index'));
      const q = savedQuestions[i] || "";
      const a = savedAnswers[i] || "";
      csv += `${i + 1},"${q.replace(/"/g, '""')}","${a.replace(/"/g, '""')}"
`;
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.setAttribute("href", URL.createObjectURL(blob));
    link.setAttribute("download", "문의히스토리_선택항목.csv");
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  window.onload = () => {
    let userId = localStorage.getItem('loggedInUser');
    if (userId) userId = userId.toLowerCase();
    if (userId && allowedIds.includes(userId)) {
      savedQuestions = JSON.parse(localStorage.getItem('savedQuestions_' + userId)) || [];
      savedAnswers = JSON.parse(localStorage.getItem('savedAnswers_' + userId)) || [];
      showChatPage(userId);
      if (userId === "danbi") {
        document.getElementById('adminPage').style.display = 'block';
        renderHistory(userId);
      }
    }
  }
</script>